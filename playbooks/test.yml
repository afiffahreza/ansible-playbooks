---
- name: Revoke VPN access for a user
  hosts: localhost
  pre_tasks:
    - block:
        - name: Ensure all vars defined
          assert:
            that: "{{ item }} is defined"
            msg: "variable {{ item }} must be defined"
          with_items:
            - str

  tasks:
    - set_fact:
        search_string: "search_{{ str }}"
      run_once: yes

    - name: search string
      shell: grep {{ search_string }} /home/afif/ansible-vpn/txt/test.txt | cat
      register: presence

    - name: Fail when string is not found
      ansible.builtin.fail:
        msg: String not found
      when: "{{ presence }}.stdout == ''"

    - name: Set searched string content
      copy:
        dest: "/home/afif/string.txt"
        content: "{{ search_string }}"

    - name: Changing perm sh
      file: dest=/home/afif/ansible-vpn/sh/test.sh mode=a+x

    - name: Test
      ansible.builtin.command: "/home/afif/ansible-vpn/sh/test.sh"
